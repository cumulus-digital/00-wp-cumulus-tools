!function(){"use strict";var e=window.React,t=window.wp.hooks,r=window.wp.compose,o=window.wp.components,s=window.wp.blockEditor,a=window.wp.element,n=window.wp.data;const l=["core/post-terms"],c=(0,r.createHigherOrderComponent)((t=>r=>{if(!l.includes(r.name))return(0,e.createElement)(t,{...r});const{attributes:c,setAttributes:i,isSelected:u}=r,{term:p}=c,[d,m]=(0,a.useState)(!1),[g,y]=(0,a.useState)([]),{postType:b}=(0,n.useSelect)((e=>({postType:e("core/editor").getCurrentPostType()})),[]),{availableTaxonomies:h,isLoading:f}=(0,n.useSelect)((e=>{const t={type:b,context:"view",per_page:-1};return{availableTaxonomies:e("core").getTaxonomies(t),isLoading:e("core/data").isResolving("core","getTaxonomies",t)}}),[b]);return(0,a.useEffect)((()=>{if(!h)return void y([{label:"Loading..."}]);if(!h.length)return void y([{label:"None available"}]);let e=!1;const t=h.map((t=>(t.slug===p&&(e=!0),{label:t.name,value:t.slug})));if(e)m(!1);else{let e=null;"post_tag"===p&&(e=h.find((e=>!1===e.hierarchical))),"category"===p&&(e=h.find((e=>!0===e.hierarchical))),e?i({term:e.slug}):(m(!0),i({term:t[0].value})),t.unshift({label:"Select a taxonomy",value:null})}y(t)}),[h]),(0,e.createElement)(e.Fragment,null,u&&!f&&(0,e.createElement)(s.InspectorControls,null,(0,e.createElement)(o.Panel,null,(0,e.createElement)(o.PanelBody,{title:"Taxonomy",initialOpen:d},(0,e.createElement)(o.SelectControl,{label:"Taxonomy Type",value:p,options:g,onChange:e=>i({term:e}),help:"Only taxonomies associated with the current post type are available."})))),(0,e.createElement)(t,{...r}))}),"withTaxTypeSelector");(0,t.addFilter)("editor.BlockEdit","cmls/block-filters/post-types/taxonomies",c);var i=window.wp.coreData,u=window.wp.htmlEntities;window.wp.blocks;const p=[],d={order:"asc",_fields:"id,name",context:"view"},m=(e,t)=>{const r=t?.id||e?.find((e=>e.name===t))?.id;if(r)return r;const o=t.toLocaleLowerCase();return e?.find((e=>e.name.toLocaleLowerCase()===o))?.id};function g({onChange:t,query:r}){const{postType:o,taxQuery:s}=r,l=(e=>{const t=(0,n.useSelect)((t=>{const{getTaxonomies:r}=t(i.store);return r({type:e,per_page:-1})}),[e]);return(0,a.useMemo)((()=>t?.filter((({visibility:e})=>!!e?.publicly_queryable))),[t])})(o);return l&&0!==l.length?(0,e.createElement)(e.Fragment,null,l.map((r=>{const o=s?.[r.slug]||[];return(0,e.createElement)(y,{key:r.slug,taxonomy:r,termIds:o,onChange:e=>t({taxQuery:{...s,[r.slug]:e}})})}))):null}function y({taxonomy:t,termIds:s,onChange:l}){const[c,g]=(0,a.useState)(""),[y,b]=(0,a.useState)(p),[h,f]=(0,a.useState)(p),x=(0,r.useDebounce)(g,250),{searchResults:E,searchHasResolved:w}=(0,n.useSelect)((e=>{if(!c)return{searchResults:p,searchHasResolved:!0};const{getEntityRecords:r,hasFinishedResolution:o}=e(i.store),a=["taxonomy",t.slug,{...d,search:c,orderby:"name",exclude:s,per_page:20}];return{searchResults:r(...a),searchHasResolved:o("getEntityRecords",a)}}),[c,s]),C=(0,n.useSelect)((e=>{if(!s?.length)return p;const{getEntityRecords:r}=e(i.store);return r("taxonomy",t.slug,{...d,include:s,per_page:s.length})}),[s]);return(0,a.useEffect)((()=>{if(s?.length||b(p),!C?.length)return;const e=s.reduce(((e,t)=>{const r=C.find((e=>e.id===t));return r&&e.push({id:t,value:r.name}),e}),[]);b(e)}),[s,C]),(0,a.useEffect)((()=>{w&&f(E.map((e=>e.name)))}),[E,w]),(0,e.createElement)("div",{className:"block-library-query-inspector__taxonomy-control"},(0,e.createElement)(o.FormTokenField,{label:t.name,value:y,onInputChange:x,suggestions:h,displayTransform:u.decodeEntities,onChange:e=>{const t=new Set;for(const r of e){const e=m(E,r);e&&t.add(e)}f(p),l(Array.from(t))},__experimentalShowHowTo:!1}))}(0,t.addFilter)("blocks.registerBlockType","cmls/block-filters/search/filters",((e,t)=>("core/search"!==t||(e.attributes={...e?.attributes,baseCategory:{type:"string"},query:{type:"object",default:{postType:null,author:"",exclude:"",sticky:"",taxQuery:null}}}),e)));const b=(0,r.createHigherOrderComponent)((t=>r=>{if("core/search"!==r.name)return(0,e.createElement)(t,{...r});const{attributes:l,setAttributes:c,isSelected:u}=r,[p,d]=(0,a.useState)([]),[m,y]=(0,a.useState)([]),b=e=>c({query:{...l.query,...e}}),{postTypesTaxonomiesMap:h,postTypesSelectOptions:f}=(()=>{const e=(0,n.useSelect)((e=>{const{getPostTypes:t}=e(i.store),r=["attachment"],o=t({per_page:-1})?.filter((({viewable:e,slug:t})=>e&&!r.includes(t)));return o}),[]);return{postTypesTaxonomiesMap:(0,a.useMemo)((()=>{if(e?.length)return e.reduce(((e,t)=>(e[t.slug]=t.taxonomies,e)),{})}),[e]),postTypesSelectOptions:(0,a.useMemo)((()=>(e||[]).map((({labels:e,slug:t})=>({label:e.singular_name,value:t})))),[e])}})();(0,a.useEffect)((()=>{d([{value:"",label:"None"},...f])}),[f]);const{postCategories:x,postCategoriesLoading:E}=(0,n.useSelect)((e=>"post"!==l?.query?.postType?[]:{postCategories:e("core").getEntityRecords("taxonomy","category",{per_page:-1}),postCategoriesLoading:e("core/data").isResolving("core","getEntityRecords",["taxonomy","category",{per_page:-1}])}),[l.query,l.baseCategory]);return(0,a.useEffect)((()=>{if(E)y([{value:"",label:"Loading categoriesâ€¦"}]);else if(x){const e=x.map((e=>({value:e.slug,label:e.name})));y([{value:"",label:"None"},...e])}else y([{label:"None available",value:""}])}),[x,E]),(0,e.createElement)(e.Fragment,null,u&&(0,e.createElement)(s.InspectorControls,null,(0,e.createElement)(o.Panel,null,(0,e.createElement)(o.PanelBody,{title:"Filters",initialOpen:!0},(0,e.createElement)("p",null,"Restrict searches to a simple post category, or a more complex filter with other post types and taxonomy terms."),(0,e.createElement)(o.SelectControl,{label:"Post Type",value:l?.query?.postType||"",options:p,onChange:e=>{const t={postType:e},r=h[e],o=Object.entries(l?.query?.taxQuery||{}).reduce(((e,[t,o])=>(r&&r.includes(t)&&(e[t]=o),e)),{});t.taxQuery=Object.keys(o).length?o:void 0,t.sticky="",c({baseCategory:""}),b(t)}}),"post"===l?.query?.postType&&(0,e.createElement)(o.SelectControl,{label:"Base Category",help:"Searches can be restricted to a single Post category with a friendly URL.",value:l.baseCategory,options:m,onChange:e=>c({baseCategory:e})}),!l.baseCategory&&(0,e.createElement)(e.Fragment,null,l?.query?.postType&&(0,e.createElement)(g,{query:l?.query,onChange:b}))))),(0,e.createElement)(t,{...r}))}));(0,t.addFilter)("editor.BlockEdit","cmls/block-filters/search/filters",b),(0,t.addFilter)("blocks.registerBlockType","cmls/block-filters/query/filters/ajax",((e,t)=>"core/query"!==t?e:Object.assign({},e,{attributes:Object.assign({},e.attributes,{useAjax:{type:"boolean",default:!1}})})));const h=(0,r.createHigherOrderComponent)((t=>r=>{if("core/query"!==r.name)return(0,e.createElement)(t,{...r});const{attributes:a,setAttributes:n,isSelected:l}=r;return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...r}),l&&(0,e.createElement)(s.InspectorAdvancedControls,null,(0,e.createElement)(o.PanelRow,null,(0,e.createElement)(o.ToggleControl,{label:"Use Ajax Pagination",help:"Pagination reloads the block in place instead of reloading the page",checked:!!a.useAjax,onChange:e=>n({useAjax:!a.useAjax})}))))}));(0,t.addFilter)("editor.BlockEdit","cmls/block-filters/query/filters/ajax",h),wp.hooks.addFilter("blocks.getSaveContent.extraProps","cmls/block-filters/query/filters/ajax",((e,t,r)=>("core/query"!==t.name||(e.className=e.className.replace(/\s*uses?\-ajax\s*/,""),r.useAjax&&(e.className+=" uses-ajax")),e))),(0,t.addFilter)("blocks.registerBlockType","cmls/block-filters/query/filters/exclude-ids",((e,t)=>"core/query"!==t?e:Object.assign({},e,{usesContext:Array.isArray(e?.usesContext)?[...e.usesContext,"postId"]:["postId"]})));const f=(0,r.createHigherOrderComponent)((t=>r=>{if("core/query"!==r.name)return(0,e.createElement)(t,{...r});const{attributes:a,setAttributes:n,isSelected:l}=r;return r?.context?.postId?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...r}),l&&(0,e.createElement)(s.InspectorControls,null,(0,e.createElement)(o.PanelBody,{title:"Exclude IDs",initialOpen:!!a.query.exclude?.length},(0,e.createElement)(o.ToggleControl,{label:"Exclude This Page",help:"Adds the current post ID to excluded IDs.",checked:a.query.exclude.includes(r.context.postId),onChange:e=>{const t=a.query,o=r.context.postId;t.exclude=t.exclude.filter((e=>e!==o)),e&&t.exclude.push(o),n({query:{...a.query,...t}})}}),(0,e.createElement)(o.FormTokenField,{label:"Excluded IDs",value:a.query.exclude,onChange:e=>n({query:{...a.query,exclude:e.filter((e=>isNumber(e)))}})})))):(0,e.createElement)(t,{...r})}));(0,t.addFilter)("editor.BlockEdit","cmls/block-filters/query/filters/exclude-ids",f);const x=["core/audio","core/calendar","core/categories","core/cover","core/embed","core/group","core/image","core/latest-comments","core/latest-posts","core/list","core/media-text","core/post-author","core/post-author-name","core/post-date","core/post-content","core/post-excerpt","core/post-template","core/query","core/query-pagination","core/query-pagination-previous","core/query-pagination-next","core/query-pagination-numbers","core/search","core/separator","core/tag-cloud","core/video"],E=(e,t)=>{if(!x.includes(t))return e;if(!0===e?.supports?.spacing?.margin||Array.isArray(e?.supports?.spacing?.margin)&&e?.supports?.spacing?.margin.includes("top")&&e?.supports?.spacing?.margin.includes("bottom"))return e;let r=["top","bottom"];return e?.supports?.spacing?.margin&&(r=[e?.supports?.spacing?.margin,...r]),e.supports={...e?.supports,spacing:{...e?.supports?.spacing,margin:r,__experimentalDefaultControls:Object.assign(e?.supports?.spacing?.margin?.__experimentalDefaultControls||{},{margin:!0})}},e.attributes={...e?.attributes,style:{type:"object"}},console.debug(`wp-cumulus-tools/block-filters/add-margin-support - Added margin support to ${t}`),e};(0,t.addFilter)("blocks.registerBlockType","cmls/block-filters/add-margin-support",E),wp.hooks.addFilter("blocks.getSaveContent.extraProps","cmls/block-filters/add-margin-support",E);const w=(0,r.createHigherOrderComponent)((t=>r=>{if(!x.includes(r.name))return(0,e.createElement)(t,{...r});const{attributes:o}=r,s={marginTop:o?.style?.spacing?.margin?.top,marginBottom:o?.style?.spacing?.margin?.bottom};return(0,e.createElement)(t,{...r,wrapperProps:{style:s}})}),"addSpacingStypesToSeparator");wp.hooks.addFilter("editor.BlockListBlock","cmls/block-filters/add-margin-support",w)}();