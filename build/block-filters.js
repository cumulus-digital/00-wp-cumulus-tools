!function(){"use strict";var e=window.wp.hooks,t=window.wp.compose,s=window.wp.components,o=window.wp.blockEditor,r=window.wp.element,a=window.wp.data,n=window.ReactJSXRuntime;const l=["core/post-terms"],i=(0,t.createHigherOrderComponent)(e=>t=>{if(!l.includes(t.name))return(0,n.jsx)(e,{...t});const{attributes:i,setAttributes:c,isSelected:u}=t,{term:p}=i,[d,g]=(0,r.useState)(!1),[m,y]=(0,r.useState)([]),{postType:x}=(0,a.useSelect)(e=>({postType:e("core/editor").getCurrentPostType()}),[]),{availableTaxonomies:h,isLoading:b}=(0,a.useSelect)(e=>{const t={type:x,context:"view",per_page:-1};return{availableTaxonomies:e("core").getTaxonomies(t),isLoading:e("core/data").isResolving("core","getTaxonomies",t)}},[x]);return(0,r.useEffect)(()=>{if(!h)return void y([{label:"Loading..."}]);if(!h.length)return void y([{label:"None available"}]);let e=!1;const t=h.map(t=>(t.slug===p&&(e=!0),{label:t.name,value:t.slug}));if(e)g(!1);else{let e=null;"post_tag"===p&&(e=h.find(e=>!1===e.hierarchical)),"category"===p&&(e=h.find(e=>!0===e.hierarchical)),e?c({term:e.slug}):(g(!0),c({term:t[0].value})),t.unshift({label:"Select a taxonomy",value:null})}y(t)},[h]),(0,n.jsxs)(n.Fragment,{children:[u&&!b&&(0,n.jsx)(o.InspectorControls,{children:(0,n.jsx)(s.Panel,{children:(0,n.jsx)(s.PanelBody,{title:"Taxonomy",initialOpen:d,children:(0,n.jsx)(s.SelectControl,{label:"Taxonomy Type",value:p,options:m,onChange:e=>c({term:e}),help:"Only taxonomies associated with the current post type are available."})})})}),(0,n.jsx)(e,{...t})]})},"withTaxTypeSelector");(0,e.addFilter)("editor.BlockEdit","cmls/block-filters/post-types/taxonomies",i);var c=window.wp.coreData,u=window.wp.htmlEntities,p=window.wp.i18n;window.wp.blocks;const d=[],g={order:"asc",_fields:"id,name",context:"view"},m=(e,t)=>{const s=t?.id||e?.find(e=>e.name===t)?.id;if(s)return s;const o=t.toLocaleLowerCase();return e?.find(e=>e.name.toLocaleLowerCase()===o)?.id};function y({onChange:e,query:t}){const{postType:o,taxQuery:l}=t,i=(e=>{const t=(0,a.useSelect)(t=>{const{getTaxonomies:s,getPostType:o}=t(c.store);return o(e)?.taxonomies?.length>0?s({type:e,per_page:-1}):[]},[e]);return(0,r.useMemo)(()=>t?.filter(({visibility:e})=>!!e?.publicly_queryable),[t])})(o);return i?.length?(0,n.jsx)(s.__experimentalVStack,{spacing:4,children:i.map(t=>{const s=l?.include?.[t.slug]||[],o=l?.exclude?.[t.slug]||[],a=(s,o)=>{const r={...l?.[o],[t.slug]:s};s.length||delete r[t.slug];const a={...l,[o]:Object.keys(r).length?r:void 0};e({taxQuery:Object.values(a).every(e=>!e)?void 0:a})};return(0,n.jsxs)(r.Fragment,{children:[(0,n.jsx)(x,{taxonomy:t,termIds:s,oppositeTermIds:o,onChange:e=>a(e,"include"),label:t.name}),(0,n.jsx)(x,{taxonomy:t,termIds:o,oppositeTermIds:s,onChange:e=>a(e,"exclude"),label:/* translators: %s: taxonomy name */ /* translators: %s: taxonomy name */
(0,p.sprintf)((0,p.__)("Exclude: %s"),t.name)})]},t.slug)})}):null}function x({taxonomy:e,termIds:o,oppositeTermIds:l,onChange:i,label:p}){const[y,x]=(0,r.useState)(""),[h,b]=(0,r.useState)(d),[f,j]=(0,r.useState)(d),w=(0,t.useDebounce)(x,250),{searchResults:C,searchHasResolved:T}=(0,a.useSelect)(t=>{if(!y)return{searchResults:d,searchHasResolved:!0};const{getEntityRecords:s,hasFinishedResolution:r}=t(c.store),a=[...o,...l],n=["taxonomy",e.slug,{...g,search:y,orderby:"name",exclude:a,per_page:20}];return{searchResults:s(...n),searchHasResolved:r("getEntityRecords",n)}},[y,e.slug,o,l]),k=(0,a.useSelect)(t=>{if(!o?.length)return d;const{getEntityRecords:s}=t(c.store);return s("taxonomy",e.slug,{...g,include:o,per_page:o.length})},[e.slug,o]);return(0,r.useEffect)(()=>{if(o?.length||b(d),!k?.length)return;const e=o.reduce((e,t)=>{const s=k.find(e=>e.id===t);return s&&e.push({id:t,value:s.name}),e},[]);b(e)},[o,k]),(0,r.useEffect)(()=>{T&&j(C.map(e=>e.name))},[C,T]),(0,n.jsx)("div",{className:"block-library-query-inspector__taxonomy-control",children:(0,n.jsx)(s.FormTokenField,{label:p,value:h,onInputChange:w,suggestions:f,displayTransform:u.decodeEntities,onChange:e=>{const t=new Set;for(const s of e){const e=m(C,s);e&&t.add(e)}j(d),i(Array.from(t))},__experimentalShowHowTo:!1,__next40pxDefaultSize:!0})})}(0,e.addFilter)("blocks.registerBlockType","cmls/block-filters/search/filters",(e,t)=>("core/search"!==t||(e.attributes={...e?.attributes,baseCategory:{type:"string"},query:{type:"object",default:{postType:null,author:"",exclude:"",sticky:"",taxQuery:null}}}),e));const h=(0,t.createHigherOrderComponent)(e=>t=>{if("core/search"!==t.name)return(0,n.jsx)(e,{...t});const{attributes:l,setAttributes:i,isSelected:u}=t,[p,d]=(0,r.useState)([]),[g,m]=(0,r.useState)([]),x=e=>i({query:{...l.query,...e}}),{postTypesTaxonomiesMap:h,postTypesSelectOptions:b}=(()=>{const e=(0,a.useSelect)(e=>{const{getPostTypes:t}=e(c.store),s=["attachment"],o=t({per_page:-1})?.filter(({viewable:e,slug:t})=>e&&!s.includes(t));return o},[]);return{postTypesTaxonomiesMap:(0,r.useMemo)(()=>{if(e?.length)return e.reduce((e,t)=>(e[t.slug]=t.taxonomies,e),{})},[e]),postTypesSelectOptions:(0,r.useMemo)(()=>(e||[]).map(({labels:e,slug:t})=>({label:e.singular_name,value:t})),[e]),postTypeFormatSupportMap:(0,r.useMemo)(()=>e?.length?e.reduce((e,t)=>(e[t.slug]=t.supports?.["post-formats"]||!1,e),{}):{},[e])}})();(0,r.useEffect)(()=>{d([{value:"",label:"None"},...b])},[b]);const{postCategories:f,postCategoriesLoading:j}=(0,a.useSelect)(e=>"post"!==l?.query?.postType?[]:{postCategories:e("core").getEntityRecords("taxonomy","category",{per_page:-1}),postCategoriesLoading:e("core/data").isResolving("core","getEntityRecords",["taxonomy","category",{per_page:-1}])},[l.query,l.baseCategory]);return(0,r.useEffect)(()=>{if(j)m([{value:"",label:"Loading categoriesâ€¦"}]);else if(f){const e=f.map(e=>({value:e.slug,label:e.name}));m([{value:"",label:"None"},...e])}else m([{label:"None available",value:""}])},[f,j]),(0,n.jsxs)(n.Fragment,{children:[u&&(0,n.jsx)(o.InspectorControls,{children:(0,n.jsx)(s.Panel,{children:(0,n.jsxs)(s.PanelBody,{title:"Filters",initialOpen:!0,children:[(0,n.jsx)("p",{children:"Restrict searches to a simple post category, or a more complex filter with other post types and taxonomy terms."}),(0,n.jsx)(s.SelectControl,{label:"Post Type",value:l?.query?.postType||"",options:p,onChange:e=>{const t={postType:e},s=h[e],o=Object.entries(l?.query?.taxQuery||{}).reduce((e,[t,o])=>(s&&s.includes(t)&&(e[t]=o),e),{});t.taxQuery=Object.keys(o).length?o:void 0,t.sticky="",i({baseCategory:""}),x(t)}}),"post"===l?.query?.postType&&(0,n.jsx)(s.SelectControl,{label:"Base Category",help:"Searches can be restricted to a single Post category with a friendly URL.",value:l.baseCategory,options:g,onChange:e=>i({baseCategory:e})}),!l.baseCategory&&(0,n.jsx)(n.Fragment,{children:l?.query?.postType&&(0,n.jsx)(y,{query:l?.query,onChange:x})})]})})}),(0,n.jsx)(e,{...t})]})});(0,e.addFilter)("editor.BlockEdit","cmls/block-filters/search/filters",h),(0,e.addFilter)("blocks.registerBlockType","cmls/block-filters/query/filters/ajax",(e,t)=>"core/query"!==t?e:Object.assign({},e,{attributes:Object.assign({},e.attributes,{useAjax:{type:"boolean",default:!1}})}));const b=(0,t.createHigherOrderComponent)(e=>t=>{if("core/query"!==t.name)return(0,n.jsx)(e,{...t});const{attributes:r,setAttributes:a,isSelected:l}=t;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e,{...t}),l&&(0,n.jsx)(o.InspectorAdvancedControls,{children:(0,n.jsx)(s.PanelRow,{children:(0,n.jsx)(s.ToggleControl,{label:"Use Ajax Pagination",help:"Pagination reloads the block in place instead of reloading the page",checked:!!r.useAjax,onChange:e=>a({useAjax:!r.useAjax})})})})]})});(0,e.addFilter)("editor.BlockEdit","cmls/block-filters/query/filters/ajax",b),wp.hooks.addFilter("blocks.getSaveContent.extraProps","cmls/block-filters/query/filters/ajax",(e,t,s)=>("core/query"!==t.name||(e.className=e.className.replace(/\s*uses?\-ajax\s*/,""),s.useAjax&&(e.className+=" uses-ajax")),e)),(0,e.addFilter)("blocks.registerBlockType","cmls/block-filters/query/filters/exclude-ids",(e,t)=>{if("core/query"!==t)return e;const s=e;return s?.usesContext?.length&&s.usesContext.includes("postId")||(s.usesContext=[...s?.usesContext,"postId"]),s});const f=(0,t.createHigherOrderComponent)(e=>t=>{if("core/query"!==t.name)return(0,n.jsx)(e,{...t});const{attributes:r,setAttributes:a,isSelected:l}=t;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e,{...t}),l&&(0,n.jsx)(o.InspectorControls,{children:(0,n.jsxs)(s.PanelBody,{title:"Exclude IDs",initialOpen:!!r.query.exclude?.length,children:[t.context?.postId&&(0,n.jsx)(s.ToggleControl,{label:"Exclude This Page",help:"Adds the current post ID to excluded IDs.",checked:!!r.query.exclude?.length&&r.query.exclude.includes(t.context.postId),onChange:e=>{const s=r.query,o=t.context.postId;isNumber(o)&&(s.exclude=[...new Set([...s.exclude,o])]),a({query:{...r.query,...s}})}}),(0,n.jsx)(s.FormTokenField,{label:"Excluded IDs",value:r.query.exclude,onChange:e=>a({query:{...r.query,exclude:[...new Set(e.filter(e=>isNumber(e)))]}})})]})})]})});(0,e.addFilter)("editor.BlockEdit","cmls/block-filters/query/filters/exclude-ids",f);const j=["core/audio","core/calendar","core/categories","core/cover","core/embed","core/group","core/image","core/latest-comments","core/latest-posts","core/list","core/media-text","core/post-author","core/post-author-name","core/post-date","core/post-content","core/post-excerpt","core/post-template","core/query","core/query-pagination","core/query-pagination-previous","core/query-pagination-next","core/query-pagination-numbers","core/search","core/separator","core/tag-cloud","core/video"],w=(e,t)=>{if(!j.includes(t))return e;if(!0===e?.supports?.spacing?.margin||Array.isArray(e?.supports?.spacing?.margin)&&e?.supports?.spacing?.margin.includes("top")&&e?.supports?.spacing?.margin.includes("bottom"))return e;let s=["top","bottom"];return e?.supports?.spacing?.margin&&(s=[e?.supports?.spacing?.margin,...s]),e.supports={...e?.supports,spacing:{...e?.supports?.spacing,margin:s,__experimentalDefaultControls:Object.assign(e?.supports?.spacing?.margin?.__experimentalDefaultControls||{},{margin:!0})}},e.attributes={...e?.attributes,style:{type:"object"}},console.debug(`wp-cumulus-tools/block-filters/add-margin-support - Added margin support to ${t}`),e};(0,e.addFilter)("blocks.registerBlockType","cmls/block-filters/add-margin-support",w),wp.hooks.addFilter("blocks.getSaveContent.extraProps","cmls/block-filters/add-margin-support",w);const C=(0,t.createHigherOrderComponent)(e=>t=>{if(!j.includes(t.name))return(0,n.jsx)(e,{...t});const{attributes:s}=t,o={marginTop:s?.style?.spacing?.margin?.top,marginBottom:s?.style?.spacing?.margin?.bottom};return(0,n.jsx)(e,{...t,wrapperProps:{style:o}})},"addSpacingStypesToSeparator");wp.hooks.addFilter("editor.BlockListBlock","cmls/block-filters/add-margin-support",C)}();